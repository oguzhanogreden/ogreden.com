<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta name="apple-mobile-web-app-capable" content="yes"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title> Bayesian change point analysis using PyMC3 | Ozan Öğreden </title> <meta name="description" content=" Personal homepage. "> <meta name="keywords" content="Ozan Öğreden, personal homepage"> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <!-- Social: Facebook / Open Graph --> <meta property="og:type" content="article"> <meta property="article:author" content="Ozan Öğreden"> <meta property="article:section" content="writing"> <meta property="article:tag" content=""> <meta property="article:published_time" content="2020-12-19 00:00:00 +0100"> <meta property="og:url" content="https://ozan.ogreden.com/2020/12/19/switchpoint-analysis-pymc3/"> <meta property="og:title" content=" Bayesian change point analysis using PyMC3 | Ozan Öğreden "> <meta property="og:image" content="https://ozan.ogreden.com"> <meta property="og:description" content=" Personal homepage. "> <meta property="og:site_name" content="Ozan Öğreden"> <meta property="og:locale" content="en_US"> <!-- Social: Twitter --> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:site" content="oguzhanogred_en"> <meta name="twitter:title" content=" Bayesian change point analysis using PyMC3 | Ozan Öğreden "> <meta name="twitter:description" content=" Personal homepage. "> <meta name="twitter:image:src" content="https://ozan.ogreden.com"> <!-- Social: Google+ / Schema.org --> <meta itemprop="name" content=" Bayesian change point analysis using PyMC3 | Ozan Öğreden "> <meta itemprop="description" content=" Personal homepage. "> <meta itemprop="image" content="https://ozan.ogreden.com"> <!-- Canonical link tag --> <!-- <meta http-equiv="refresh" content="0; url=/2020/12/19/switchpoint-analysis-pymc3/"> <link rel="canonical" href="/2020/12/19/switchpoint-analysis-pymc3/"> --> <link rel="canonical" href="https://ozan.ogreden.com/2020/12/19/switchpoint-analysis-pymc3/"> <link rel="alternate" type="application/rss+xml" title="Ozan Öğreden" href="https://ozan.ogreden.com/feed.xml"> <!-- rel prev and next --> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css" /> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.0/es5/tex-mml-chtml.js"> </script> </head> <body> <main class="wrapper"> <header class="site-header"> <nav class="nav"> <div class="container"> <h1 class="logo"> <a href="https://ozan.ogreden.com/" >Ozan Öğreden<span></span></a > </h1> <ul class="navbar"> <li> <a href="/today-i-learned">today I learned</a> </li> <li> <a href="/cv">CV</a> </li> </ul> </div> </nav> </header> <article class="post container" itemscope itemtype="http://schema.org/BlogPosting"> <!-- don't show titles on zettels --> <header class="post-header"> <p class="post-meta"><time datetime="2020-12-19T00:00:00+01:00" itemprop="datePublished">Dec 19, 2020</time></p> <h4 class="post-title" itemprop="name headline">Bayesian change point analysis using PyMC3</h4> </header> <div class="post-content" itemprop="articleBody"> <hr /> <p><em>Friendly reminder of <a href="/2020/12/05/montaigne-warning/">Montaigne's warning</a> and <a href="/2021/01/08/writing/">why I write</a>.</em> <hr /> <br> <p>I earlier wrote about how <a href="/2020/12/05/beeminder-flossing/">Beeminder helped me make a flossing habit</a><!-- [[202011260914 beeminder black friday post about flossing]] -->. In that post, I also touched upon a small “experiment” I made by decreasing my flossing commitment in Beeminder to see if I could keep the habit up <!-- [[202011260836]] --> - a friend of mine had put her faith in me that I can. I failed her. But I’m a regular flosser these days, so there’s that.</p> <p>In the meanwhile, I had an assignment at work where I needed a simple Bayesian model. I chose to use PyMC3, and not having used it before, I read a lot of documentation and worked out a few toy examples. During these exercises, I also analysed the said experiment. Here’s how that went.</p> <p>First of all, here’s what the data looked like:</p> <p><img src="/assets/images/Pasted image 20201219135858.png" alt="" /></p> <p>It’s pretty obvious that my flossing rate has changed around half of October. My goal was to reach this conclusion more formally, using PyMC3. It’s not the most exciting analysis, and the solution is borrowed from a StackOverflow answer <sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote">1</a></sup>, but it makes for good <a href="/2021/01/08/writing/">writing exercise</a> <!-- [[202012062149]] --> (and I now also have a Beeminder goal that forces me to write things here<!-- [[202012170753]] -->).</p> <p>First, I needed some data processing to obtain my flossing rate by using <code class="language-plaintext highlighter-rouge">pandas.date_range</code> and a join. Once the data is ready, the PyMC3 code for the model looked like this:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">flossing_data</span>

<span class="k">with</span> <span class="n">pm</span><span class="p">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>
    <span class="c1"># Priors
</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">HalfCauchy</span><span class="p">(</span><span class="s">'sigma'</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">testval</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
    
    <span class="n">switch_lower</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">"index"</span><span class="p">].</span><span class="nb">min</span><span class="p">()</span>
    <span class="n">switch_upper</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">"index"</span><span class="p">].</span><span class="nb">max</span><span class="p">()</span>
    <span class="n">switchpoint</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">DiscreteUniform</span><span class="p">(</span><span class="s">'switchpoint'</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="n">switch_lower</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">switch_upper</span><span class="p">)</span> 
    
    <span class="c1">## Priors for the intercept are informative
</span>
    <span class="n">intercept_u1</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Uniform</span><span class="p">(</span><span class="s">'Intercept_u1'</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="p">.</span><span class="mi">75</span><span class="p">)</span> 
    <span class="n">intercept_u2</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Uniform</span><span class="p">(</span><span class="s">'Intercept_u2'</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="p">.</span><span class="mi">75</span><span class="p">)</span>
    
    <span class="c1"># Model
</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">"index"</span><span class="p">].</span><span class="n">values</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">"value"</span><span class="p">].</span><span class="n">values</span>
    
    <span class="n">intercept</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">math</span><span class="p">.</span><span class="n">switch</span><span class="p">(</span><span class="n">switchpoint</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">,</span> <span class="n">intercept_u1</span><span class="p">,</span> <span class="n">intercept_u2</span><span class="p">)</span>
    
    <span class="c1"># Likelihood
</span>
    <span class="n">likelihood</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Normal</span><span class="p">(</span><span class="s">"value"</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">intercept</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
    
<span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">step1</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">NUTS</span><span class="p">([</span><span class="n">intercept_u1</span><span class="p">,</span> <span class="n">intercept_u2</span><span class="p">,])</span>
    <span class="n">step2</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Metropolis</span><span class="p">([</span><span class="n">switchpoint</span><span class="p">])</span>

    <span class="n">trace</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="p">[</span><span class="n">step1</span><span class="p">,</span> <span class="n">step2</span><span class="p">],</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">progressbar</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>  
</code></pre></div></div> <p>The parameter of interest was “switchpoint” and here’s how the posterior samples for this parameter looked, alongside the data itself:</p> <p><img src="/assets/images/Pasted image 20201219141317.png" alt="" /></p> <p>The model hedged its bet around the 48th day. Remarkably, the 94% probability range covers 17th to 74th day. This is largely due to the uninformative prior on the switchpoint parameter. We could have done better by specifying a prior that are a bit more informative and reduce the weight on the earlier and the later days.</p> <p>Next to the parameter of interest, the “Intercept_u1” and “Intercept_u2” parameters could be interpreted as the daily rates of flossing and before and after the switchpoint, respectively:</p> <p><img src="/assets/images/Pasted image 20201219142108.png" alt="" /></p> <p>So the rate with which I flossed seemed to have decreased. In fact, we can test the hypothesis directly using the posterior samples:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">posterior_intercepts</span> <span class="o">=</span> <span class="n">pm_data</span><span class="p">.</span><span class="n">posterior</span><span class="p">[[</span><span class="s">"Intercept_u1"</span><span class="p">,</span> <span class="s">"Intercept_u2"</span><span class="p">]].</span><span class="n">to_dataframe</span><span class="p">()</span>
<span class="n">h_u1_gt_u2</span> <span class="o">=</span> <span class="n">posterior_intercepts</span><span class="p">[</span><span class="s">"Intercept_u1"</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">posterior_intercepts</span><span class="p">[</span><span class="s">"Intercept_u2"</span><span class="p">]</span>

<span class="n">h_u1_gt_u2</span><span class="p">.</span><span class="n">mean</span><span class="p">()</span>
<span class="c1"># &gt; 0.93925
</span></code></pre></div></div> <p>Looking at the data, the probability that I flossed more while using Beeminder than in the period I haven’t used it is 94%.</p> <p>This is a neat, albeit a trivial, example. I did learn a few elementary details about Bayesian estimation using PyMC3 in the process and it served me as a writing exercise.</p> <!-- I have a special interest in making small-to-mid-size businesses automate "graph interpretation" aspects of their work using statistical models (#incomplete write about this?). --> <!-- Technical notes: --> <!-- - "Sampling Error: Bad initial energy" roughly translates to "Something wrong while evaluating the likelihood of initial values." and can be debugged with `Model.check_test_point()`. The term energy is used here since ??? #incomplete since energy is the concept that Hamiltonian Monte Carlo uses [[202012090733]] to ??? #incomplete . I had the warning because I specified priors with no breadth. --> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:1" role="doc-endnote"> <p>See <a href="https://stackoverflow.com/questions/36045851/pymc3-regression-with-change-point/36114952">here</a> <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> </ol> </div> </div> </article> <footer class="site-footer"> <div class="container"> <!-- <small class="block" >&copy; 2021 Ozan Öğreden &middot; Powered by <a href="https://jekyllrb.com/">Jekyll</a> and <a href="https://github.com/heiswayi/thinkspace" >Thinkspace theme</a ></small > --> </div> </footer> </main> </body> </html>
