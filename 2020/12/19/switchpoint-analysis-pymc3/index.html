<!DOCTYPE html> <html> <head> <!-- Global site tag (gtag.js) - Google Analytics --> <!-- Thanks to Paul Cochrane: https://ptc-it.de/enabling-cookie-consent-with-jekyll-minimal-mistakes/ --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-M32X5EGH2D"></script> <script> function initialiseGAOnConsent() { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-M32X5EGH2D', { 'anonymizeIp': true, 'cookie_expires': 0, 'store_gac': false }); }; </script> <meta charset="utf-8"> <meta name="apple-mobile-web-app-capable" content="yes"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title> Bayesian change point analysis using PyMC3 | Ozan √ñƒüreden </title> <meta name="description" content=" Personal homepage. "> <meta name="keywords" content="Ozan √ñƒüreden, personal homepage"> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <!-- Social: Facebook / Open Graph --> <meta property="og:type" content="article"> <meta property="article:author" content="Ozan √ñƒüreden"> <meta property="article:section" content="writing"> <meta property="article:tag" content=""> <meta property="article:published_time" content="2020-12-19 00:00:00 -0600"> <meta property="og:url" content="https://ozan.ogreden.com/2020/12/19/switchpoint-analysis-pymc3/"> <meta property="og:title" content=" Bayesian change point analysis using PyMC3 | Ozan √ñƒüreden "> <meta property="og:image" content="https://ozan.ogreden.com"> <meta property="og:description" content=" Personal homepage. "> <meta property="og:site_name" content="Ozan √ñƒüreden"> <meta property="og:locale" content="en_US"> <!-- Social: Twitter --> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:site" content="oguzhanogreden"> <meta name="twitter:title" content=" Bayesian change point analysis using PyMC3 | Ozan √ñƒüreden "> <meta name="twitter:description" content=" Personal homepage. "> <meta name="twitter:image:src" content="https://ozan.ogreden.com"> <!-- Social: Google+ / Schema.org --> <meta itemprop="name" content=" Bayesian change point analysis using PyMC3 | Ozan √ñƒüreden "> <meta itemprop="description" content=" Personal homepage. "> <meta itemprop="image" content="https://ozan.ogreden.com"> <!-- Canonical link tag --> <link rel="canonical" href="https://ozan.ogreden.com/2020/12/19/switchpoint-analysis-pymc3/"> <link rel="alternate" type="application/rss+xml" title="Ozan √ñƒüreden" href="https://ozan.ogreden.com/feed.xml"> <!-- rel prev and next --> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css" /> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.0/es5/tex-mml-chtml.js"> </script> </head> <body> <main class="wrapper"> <header class="site-header"> <nav class="nav"> <div class="container"> <h1 class="logo"> <a href="https://ozan.ogreden.com/" >Ozan √ñƒüreden<span></span></a > </h1> <ul class="navbar"> <li> <a href="/cv">CV</a> </li> </ul> </div> </nav> </header> <article class="post container" itemscope itemtype="http://schema.org/BlogPosting"> <!-- don't show titles on zettels --> <header class="post-header"> <p class="post-meta"><time datetime="2020-12-19T00:00:00-06:00" itemprop="datePublished">Dec 19, 2020</time></p> <h1 class="post-title" itemprop="name headline">Bayesian change point analysis using PyMC3</h1> </header> <div class="post-content" itemprop="articleBody"> <hr /> <p><em>Friendly reminder of <a href="/2020/12/05/montaigne-warning/">Montaigne's warning</a> and <a href="/2021/01/08/writing/">why I write</a>.</em> <hr /> <br> <p>I earlier wrote about how <a href="/2020/12/05/beeminder-flossing/">Beeminder helped me make a flossing habit</a><!-- [[202011260914 beeminder black friday post about flossing]] -->. In that post, I also touched upon a small ‚Äúexperiment‚Äù I made by decreasing my flossing commitment in Beeminder to see if I could keep the habit up <!-- [[202011260836]] --> - a friend of mine had put her faith in me that I can. I failed her. But I‚Äôm a regular flosser these days, so there‚Äôs that.</p> <p>In the meanwhile, I had an assignment at work where some Bayesian modeling was due. Having never seriously used PyMC3 before, I had to read a lot of documentation and work a few toy examples. During these exercises, I also analysed the said experiment. Here‚Äôs how that went.</p> <p>First of all, here‚Äôs what the data looks like:</p> <p><img src="/assets/images/Pasted image 20201219135858.png" alt="" /></p> <p>It‚Äôs pretty obvious that my flossing rate has changed around half of October. The goal of the current analysis is to use PyMC3 to figure out when that happened. It‚Äôs not the most exciting analysis, and is borrowed from a StackOverflow answer <sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote">1</a></sup>, but it makes for good writing exercise <!-- [[202012062149]] --> (and I now also have a Beeminder goal that forces me to write things here<!-- [[202012170753]] -->).</p> <p>First, I need to do some simple data processing: My flossing rate can be thought of as times I have flossed over number of days in the period I‚Äôm analysing. However, Beeminder doesn‚Äôt report data for the days I have not flossed. This is easy to fix using <code class="language-plaintext highlighter-rouge">pandas.date_range</code> and a join.</p> <p>Once the data is ready, the PyMC3 code for the model looks like this:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">flossing_data</span>

<span class="k">with</span> <span class="n">pm</span><span class="p">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>
    <span class="c1"># Priors
</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">HalfCauchy</span><span class="p">(</span><span class="s">'sigma'</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">testval</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
    
    <span class="n">switch_lower</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">"index"</span><span class="p">].</span><span class="nb">min</span><span class="p">()</span>
    <span class="n">switch_upper</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">"index"</span><span class="p">].</span><span class="nb">max</span><span class="p">()</span>
    <span class="n">switchpoint</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">DiscreteUniform</span><span class="p">(</span><span class="s">'switchpoint'</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="n">switch_lower</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">switch_upper</span><span class="p">)</span> 
    
    <span class="c1">## Priors for the intercept are informative
</span>
    <span class="n">intercept_u1</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Uniform</span><span class="p">(</span><span class="s">'Intercept_u1'</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="p">.</span><span class="mi">75</span><span class="p">)</span> 
    <span class="n">intercept_u2</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Uniform</span><span class="p">(</span><span class="s">'Intercept_u2'</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="p">.</span><span class="mi">75</span><span class="p">)</span>
    
    <span class="c1"># Model
</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">"index"</span><span class="p">].</span><span class="n">values</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">"value"</span><span class="p">].</span><span class="n">values</span>
    
    <span class="n">intercept</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">math</span><span class="p">.</span><span class="n">switch</span><span class="p">(</span><span class="n">switchpoint</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">,</span> <span class="n">intercept_u1</span><span class="p">,</span> <span class="n">intercept_u2</span><span class="p">)</span>
    
    <span class="c1"># Likelihood
</span>
    <span class="n">likelihood</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Normal</span><span class="p">(</span><span class="s">"value"</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">intercept</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
    
<span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">step1</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">NUTS</span><span class="p">([</span><span class="n">intercept_u1</span><span class="p">,</span> <span class="n">intercept_u2</span><span class="p">,])</span>
    <span class="n">step2</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Metropolis</span><span class="p">([</span><span class="n">switchpoint</span><span class="p">])</span>

    <span class="n">trace</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="p">[</span><span class="n">step1</span><span class="p">,</span> <span class="n">step2</span><span class="p">],</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">progressbar</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>  
</code></pre></div></div> <p>The parameter of interest is ‚Äúswitchpoint‚Äù and here‚Äôs how the posterior samples for this parameter look, alongside the data itself:</p> <p><img src="/assets/images/Pasted image 20201219141317.png" alt="" /></p> <p>The model hedges its bet around 48th day. Remarkably, the 94% probability range covers 17th to 74th day. This is largely due to the completely uninformative prior we specified for switchpoint. We could have done better by specifying a prior that are a bit more informative.</p> <p>Next to the parameter of interest, the ‚ÄúIntercept_u1‚Äù and ‚ÄúIntercept_u2‚Äù parameters can be interpreted as the daily rates of flossing and before and after the switchpoint, respectively:</p> <p><img src="/assets/images/Pasted image 20201219142108.png" alt="" /></p> <p>So the rate with which I flossed seems to have decreased. In fact, hypothesis testing is for free using Bayesian statistics:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">posterior_intercepts</span> <span class="o">=</span> <span class="n">pm_data</span><span class="p">.</span><span class="n">posterior</span><span class="p">[[</span><span class="s">"Intercept_u1"</span><span class="p">,</span> <span class="s">"Intercept_u2"</span><span class="p">]].</span><span class="n">to_dataframe</span><span class="p">()</span>
<span class="n">h_u1_gt_u2</span> <span class="o">=</span> <span class="n">posterior_intercepts</span><span class="p">[</span><span class="s">"Intercept_u1"</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">posterior_intercepts</span><span class="p">[</span><span class="s">"Intercept_u2"</span><span class="p">]</span>

<span class="n">h_u1_gt_u2</span><span class="p">.</span><span class="n">mean</span><span class="p">()</span>
<span class="c1"># &gt; 0.93925
</span></code></pre></div></div> <p>Looking at the data, the probability that I flossed more while using Beeminder than in the period I haven‚Äôt used it is 94%.</p> <p>This is a neat, albeit a trivial, example. It served me as a writing exercise, and I did learn a few elementary details about Bayesian estimation using PyMC3 in the process. Yay, I guess<!-- (#incomplete write about these?) -->.</p> <!-- I have a special interest in making small-to-mid-size businesses automate "graph interpretation" aspects of their work using statistical models (#incomplete write about this?). --> <!-- Technical notes: --> <!-- - "Sampling Error: Bad initial energy" roughly translates to "Something wrong while evaluating the likelihood of initial values." and can be debugged with `Model.check_test_point()`. The term energy is used here since ??? #incomplete since energy is the concept that Hamiltonian Monte Carlo uses [[202012090733]] to ??? #incomplete . I had the warning because I specified priors with no breadth. --> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:1" role="doc-endnote"> <p>See <a href="https://stackoverflow.com/questions/36045851/pymc3-regression-with-change-point/36114952">here</a>¬†<a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> </ol> </div> </div> </article> <footer class="site-footer"> <div class="container"> <small class="block" >&copy; 2021 Ozan √ñƒüreden &middot; Powered by <a href="https://jekyllrb.com/">Jekyll</a> and <a href="https://github.com/heiswayi/thinkspace" >Thinkspace theme</a ></small > </div> </footer> </main> <!-- Thanks to osano.com for the open source version! --> <script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script> <script> window.cookieconsent.initialise({ "palette": { "popup": { "background": "#0086b3", "text": "#ffffff" }, "button": { "background": "transparent", "text": "#ffffff", "border": "#ffffff" } }, "type": "opt-in", "content": { "message": "Hi! üëã I'd like to know what you are reading using a Google Analytics cookie. Are you fine with this?", "allow": "Okay!", "deny": "No.", "link": "I do care about (your) privacy.", "href": "privacy" }, "cookie": { "secure": true, "domain": "oguzhanogreden.com" }, onInitialise: function (status) { var type = this.options.type; var didConsent = this.hasConsented(); if (type == 'opt-in' && didConsent) { initialiseGAOnConsent(); } if (type == 'opt-out' && !didConsent) { } }, onStatusChange: function(status, chosenBefore) { var type = this.options.type; var didConsent = this.hasConsented(); if (type == 'opt-in' && didConsent) { initialiseGAOnConsent(); } if (type == 'opt-out' && !didConsent) { } }, onRevokeChoice: function() { var type = this.options.type; if (type == 'opt-in') { } if (type == 'opt-out') { initialiseGAOnConsent(); } } }); </script> </body> </html>
