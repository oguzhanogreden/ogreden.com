<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta name="apple-mobile-web-app-capable" content="yes"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title>ozan öğreden</title> <meta name="description" content=""> <meta name="keywords" content="Ozan Öğreden, personal homepage"> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <!-- Social: Facebook / Open Graph --> <meta property="og:type" content="article"> <meta property="article:author" content="Ozan Öğreden"> <meta property="article:section" content="writing"> <meta property="article:tag" content=""> <meta property="article:published_time" content="2021-05-15 00:00:00 +0200"> <meta property="og:url" content="https://ozan.ogreden.com/2021/05/15/angular-nested-form/"> <meta property="og:title" content=""> <meta property="og:image" content="https://ozan.ogreden.com"> <meta property="og:description" content=""> <meta property="og:site_name" content="Ozan Öğreden"> <meta property="og:locale" content="en_US"> <!-- Social: Twitter --> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:site" content="ozanogred_en"> <meta name="twitter:title" content=""> <meta name="twitter:description" content=""> <meta name="twitter:image:src" content="https://ozan.ogreden.com"> <!-- Social: Google+ / Schema.org --> <meta itemprop="name" content=""> <meta itemprop="description" content=""> <meta itemprop="image" content="https://ozan.ogreden.com"> <!-- Canonical link tag --> <!-- <meta http-equiv="refresh" content="0; url=/2021/05/15/angular-nested-form/"> <link rel="canonical" href="/2021/05/15/angular-nested-form/"> --> <link rel="canonical" href="https://ozan.ogreden.com/2021/05/15/angular-nested-form/"> <link rel="alternate" type="application/rss+xml" title="ozan öğreden" href="https://ozan.ogreden.com/feed.xml"> <!-- rel prev and next --> <link rel="stylesheet" href="/assets/css/styles.css"> <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css" /> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.0/es5/tex-mml-chtml.js"> </script> </head> <body> <main> <div id="header-container"> <header class="site-header"> <h1 id="header-title"> <a href="/">ozan öğreden</a> </h1> </header> <nav> <div style="padding-top: 1em"> <ul> </ul> </div> </nav> </div> <article class="post-container" itemscope itemtype="http://schema.org/BlogPosting"> <!-- don't show titles on zettels --> <header class="post-header"> <p class="post-meta"><time datetime="2021-05-15T00:00:00+02:00" itemprop="datePublished">May 15, 2021</time></p> <h2 id="post-title" class="post-title" itemprop="name headline">Angular nested forms with ControlValueAccessor interface</h1> </header> <div class="post-content" itemprop="articleBody"> <p>This post has but one message for Angular users: Your nested form implementation may be better off with a ControlValueAccessor.</p> <p>I am not the first one <a href="https://stackoverflow.com/a/55674946">to do this</a>. Nevertheless a disclaimer and a request: I’ve had about four weeks of professional Angular development experience, <a href="https://brandur.org/fragments/engineering-skepticism">apply healthy skepticism</a> with abundance. I’m writing to clarify my understanding, and give something to the community. If you think the claim is preposterous, reach out!</p> <p>Now, let’s get you convinced by building up a minimally realistic example.</p> <p>Suppose we have a form that used to input how many customers we can accept in a given day. Initially, the form is very simple. There is one integer input field per day. The only validation requirement is that the capacity can’t be smaller than 0 or larger than 20.</p> <p>We implement this with one component that has a FormGroup property and bind the controls manually. This is the simplest use of Angular Reactive Forms. You can find a barebones example <a href="https://stackblitz.com/github/oguzhanogreden/example-nested-form-cva/tree/0fb88df86ee9cedd231a7fde629d18ae9f51fcec">here</a>.</p> <p>Now let’s imagine a more complex second iteration for the form. We need to be able to support varying capacity throughout the day. That is, instead of a single integer input, we need to allow the user to add/remove time periods, which are specified by a start time, an end time and a capacity. We need to make sure that user can’t enter an end time that’s earlier than the start time. And we need to make sure that the total capacity doesn’t exceed 20 within a day.</p> <p>Conceptually, we have two conceptual levels: the time period level and the day level. We can implement two components, and nest the time period component in the day component. We can then reuse the time period component within and across days, and the day component across days.</p> <p>Here’s my solution, where each component implements ControlValueAccessor.</p> <iframe style="width: 100%; height: 400px;" src="https://stackblitz.com/github/oguzhanogreden/example-nested-form-cva/tree/main?ctl=1&amp;embed=1&amp;file=src/app/form/form.component.ts&amp;hideNavigation=1&amp;view=editor"></iframe> <p>I think there are three key implementation details worth noting:</p> <ol> <li>Components that implement <code class="language-plaintext highlighter-rouge">ControlValueAccessor</code> interface bind to <code class="language-plaintext highlighter-rouge">FormControl</code>s, and not to a <code class="language-plaintext highlighter-rouge">FormGroup</code> or <code class="language-plaintext highlighter-rouge">FormArray</code>.</li> <li>You need to notify parents of value changes, just like the default value accessors for e.g. <a href="https://github.com/angular/angular/blob/11.2.13/packages/forms/src/directives/default_value_accessor.ts#L144-L148">number inputs</a> do.</li> </ol> <p>ControlValueAccessor interface is very helpful here, especially while handling nested arrays that do not have a predetermined size. The interface is called a <strong>Control</strong>ValueAccessor for a reason ;) Don’t forget the point 1 above.</p> <p>There is one final implementation detail:</p> <ol> <li>You need to trigger change detection if a parent acts in a way that a child causes a change in the validity of the parent without triggering change detection automatically. This is the case e.g. when the parent triggers initialisation of a child which initializes in invalid state.</li> </ol> <p>In my limited experience, this implementation is the most flexible and the most idiomatic one. Do you disagree? I’d be happy to learn from you!</p> </div> </article> </main> </body> </html>
